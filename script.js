/* Config and keys */
const LS_KEY_EVENTS='trainingPlanEvents',LS_KEY_SETTINGS='trainingPlanSettings';
const DEFAULT_FTP=255,DEFAULT_WEIGHT=76.5,TIMEZONE='America/Los_Angeles';
let settings={ftp:DEFAULT_FTP,prevFtp:DEFAULT_FTP,weight:DEFAULT_WEIGHT,initCtl:18,initAtl:30,projStartDate:null};

/* CSV helpers */
function parsePlanCsv(csvText){const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});const rows=parsed.data;const events=[];rows.forEach(row=>{const date=(row.Date||'').trim();const start=(row.Start||'').trim();const end=(row.End||'').trim();const title=(row.Title||'Session').trim();const type=(row.Type||'Other').trim();const duration=row.Duration_min?Number(row.Duration_min):null;const powerTarget=(row.Target_Power_W||'').trim();const tssTarget=row.TSS_Target!==undefined&&row.TSS_Target!==''?Number(String(row.TSS_Target).replace(/[^\d.-]/g,'')):null;const notes=(row.Notes||'').trim();const completed=String(row.Completed||'').toLowerCase().includes('y');const actualDuration=row.Actual_Duration_min?Number(row.Actual_Duration_min):null;const actualTss=row.Actual_TSS?Number(row.Actual_TSS):null;const autoTss=row.Auto_TSS?String(row.Auto_TSS).toLowerCase().includes('y'):true;let startISO=null,endISO=null,allDay=false;if(date){if(start){startISO=${date}T${start};endISO=end?${date}T${end}:null;}else{startISO=${date};allDay=true;}}events.push({id:crypto.randomUUID(),title,start:startISO,end:endISO,allDay,extendedProps:{type,durationMin:duration,powerTarget,tssTarget,notes,completed,actualDurationMin:actualDuration,actualTss,autoTss}});});return events;}
function serializeCsv(events){const header=['Date','Start','End','Title','Type','Duration_min','Target_Power_W','TSS_Target','Notes','Completed','Actual_Duration_min','Actual_TSS','Auto_TSS'];const rows=events.map(ev=>{const d=ev.start?.slice(0,10)||'';const s=ev.start?.includes('T')?ev.start.split('T')[1]:'';const e=ev.end?.includes('T')?ev.end.split('T')[1]:'';const xp=ev.extendedProps||{};return [d,s,e,ev.title,xp.type||'',xp.durationMin||'',xp.powerTarget||'',xp.tssTarget??'',xp.notes||'',xp.completed?'yes':'no',xp.actualDurationMin??'',xp.actualTss??'',xp.autoTss?'yes':'no'].join(',');});return [header.join(','),...rows].join('\n');}

/* ICS export (PST) */
function exportIcs(events){const lines=[];lines.push('BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Training Plan//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH');lines.push('BEGIN:VTIMEZONE','TZID:America/Los_Angeles','BEGIN:STANDARD','DTSTART:19701101T020000','TZOFFSETFROM:-0700','TZOFFSETTO:-0800','RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU','END:STANDARD','BEGIN:DAYLIGHT','DTSTART:19700308T020000','TZOFFSETFROM:-0800','TZOFFSETTO:-0700','RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU','END:DAYLIGHT','END:VTIMEZONE');const now=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';events.forEach((ev,idx)=>{const uid=ev-${idx}-${(ev.start||ev.title).replace(/[^A-Za-z0-9]/g,'')};const xp=ev.extendedProps||{};const summary=xp.completed?✔ ${ev.title}:ev.title;lines.push('BEGIN:VEVENT',UID:${uid}@trainingplan,DTSTAMP:${now},SUMMARY:${summary});const descParts=[];if(xp.type)descParts.push(Type: ${xp.type});if(xp.powerTarget)descParts.push(Target: ${xp.powerTarget});if(xp.durationMin)descParts.push(Duration: ${xp.durationMin} min);if(xp.tssTarget!=null)descParts.push(TSS: ${xp.tssTarget});if(xp.notes)descParts.push(Notes: ${xp.notes});if(xp.actualDurationMin!=null||xp.actualTss!=null){descParts.push(Actual: ${xp.actualDurationMin??'?'} min, ${xp.actualTss??'?'} TSS);}lines.push(DESCRIPTION:${descParts.join(' | ')});if(ev.allDay||!ev.start?.includes('T')){const d=(ev.start||'').slice(0,10).replace(/-/g,'');lines.push(DTSTART;VALUE=DATE:${d});}else{const startLocal=ev.start.replace(/[-:]/g,'');lines.push(DTSTART;TZID=${TIMEZONE}:${startLocal});if(ev.end){const endLocal=ev.end.replace(/[-:]/g,'');lines.push(DTEND;TZID=${TIMEZONE}:${endLocal});}}lines.push('STATUS:CONFIRMED','END:VEVENT');});lines.push('END:VCALENDAR');const blob=new Blob([lines.join('\n')],{type:'text/calendar'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='plan.ics';a.click();URL.revokeObjectURL(url);}

/* Summary + projections */
function hoursAndTssByWeek(events,useActual=false){const weeks={};events.forEach(ev=>{const xp=ev.extendedProps||{};let durMin=useActual?xp.actualDurationMin:xp.durationMin;if(!durMin&&ev.start&&ev.end){const start=new Date(ev.start),end=new Date(ev.end);durMin=Math.round((end-start)/60000);}const tss=useActual&&xp.actualTss!=null?xp.actualTss:(xp.tssTarget??0);const d=ev.start?new Date(ev.start):null;if(!d)return;const tmp=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const dayNum=(tmp.getUTCDay()+6)%7;tmp.setUTCDate(tmp.getUTCDate()-dayNum+3);const firstThursday=new Date(Date.UTC(tmp.getUTCFullYear(),0,4));const weekNo=1+Math.round(((tmp-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);const key=${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')};if(!weeks[key])weeks[key]={minutes:0,tss:0};weeks[key].minutes+=durMin||0;weeks[key].tss+=tss||0;});return weeks;}
function renderWeeklySummary(){const events=calendar.getEvents().map(ev=>({start:ev.startStr,end:ev.endStr,extendedProps:ev.extendedProps}));const planned=hoursAndTssByWeek(events,false);const actual=hoursAndTssByWeek(events,true);const el=document.getElementById('weeklySummary');el.innerHTML='';const keys=new Set([...Object.keys(planned),...Object.keys(actual)]);[...keys].sort().forEach(key=>{const p=planned[key]||{minutes:0,tss:0};const a=actual[key]||{minutes:0,tss:0};const div=document.createElement('div');div.textContent=${key}: planned ${(p.minutes/60).toFixed(1)} h / ${Math.round(p.tss)} TSS | actual ${(a.minutes/60).toFixed(1)} h / ${Math.round(a.tss)} TSS;el.appendChild(div);});}
function dailyTss(events,useActual=false){const map={};events.forEach(ev=>{const d=ev.start?ev.start.slice(0,10):null;if(!d)return;const xp=ev.extendedProps||{};const tss=useActual&&xp.actualTss!=null?xp.actualTss:(xp.tssTarget??0);map[d]=(map[d]||0)+(tss||0);});return map;}
function banisterProjection(dailyTssMap,startDateStr,initCtl,initAtl){const dates=Object.keys(dailyTssMap).sort();if(!dates.length)return{dates:[],ctl:[],atl:[],tsb:[]};let start=startDateStr?new Date(startDateStr):new Date(dates[0]);let end=new Date(dates[dates.length-1]);end.setDate(end.getDate()+14);const tauCtl=42,tauAtl=7;const ctl=[],atl=[],tsb=[],labels=[];let prevCtl=initCtl,prevAtl=initAtl;for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){const key=d.toISOString().slice(0,10);const tss=dailyTssMap[key]||0;prevCtl=prevCtl+(tss-prevCtl)/tauCtl;prevAtl=prevAtl+(tss-prevAtl)/tauAtl;ctl.push(prevCtl);atl.push(prevAtl);tsb.push(prevCtl-prevAtl);labels.push(key);}return{dates:labels,ctl,atl,tsb};}

/* Auto TSS /
function parsePowerRange(str){if(!str)return null;const m=String(str).match(/(\d+)\s[-–]\s*(\d+)/);if(m){const a=Number(m[1]),b=Number(m[2]);return(a+b)/2;}const single=String(str).match(/(\d+(.\d+)?)/);return single?Number(single[1]):null;}
function typeDefaultIF(type){const t=(type||'').toLowerCase();if(t.includes('recovery'))return 0.45;if(t.includes('z2')||t.includes('endurance'))return 0.63;if(t.includes('sweet'))return 0.90;if(t.includes('threshold'))return 0.96;if(t.includes('vo2'))return 1.10;return 0.70;}
function computeAutoTss(ev){const xp=ev.extendedProps||{};const ftp=settings.ftp;let durMin=xp.durationMin;if(!durMin&&ev.start&&ev.end){const start=new Date(ev.start),end=new Date(ev.end);durMin=Math.round((end-start)/60000);}if(!durMin)return null;const midPower=parsePowerRange(xp.powerTarget);let IF=midPower&&ftp?Math.max(0.3,Math.min(1.3,midPower/ftp)):typeDefaultIF(xp.type);const tss=Math.round(IFIF(durMin/60)*100);return tss;}

/* Calendar */
let calendar,projChart;
function initCalendar(initialEvents=[]){const calEl=document.getElementById('calendar');calendar=new FullCalendar.Calendar(calEl,{initialView:'dayGridMonth',height:'auto',timeZone:TIMEZONE,editable:true,eventStartEditable:true,eventDurationEditable:true,headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay'},events:initialEvents,eventClassNames(arg){const t=arg.event.extendedProps.type||'';const classes=[];if(arg.event.extendedProps.completed)classes.push('event-completed');if(t.toLowerCase().includes('rest'))classes.push('event-rest');if(t.toLowerCase().includes('threshold'))classes.push('event-threshold','event-quality');if(t.toLowerCase().includes('vo2'))classes.push('event-vo2','event-quality');if(t.toLowerCase().includes('endurance')||t.toLowerCase().includes('z2'))classes.push('event-z2');if(t.toLowerCase().includes('recovery'))classes.push('event-recovery');return classes;},eventClick(info){const ev=info.event;const xp=ev.extendedProps||{};const plannedDur=xp.durationMin||(ev.start&&ev.end?Math.round((new Date(ev.end)-new Date(ev.start))/60000):'');const details=document.getElementById('eventDetails');details.innerHTML=<div><strong>${ev.title}</strong></div><div>${ev.start?new Date(ev.start).toLocaleString():''}${ev.end?' — '+new Date(ev.end).toLocaleString():''}</div><div>Type: ${xp.type||''}</div><div>Planned Duration: ${plannedDur} min</div><div>Planned TSS: ${xp.tssTarget??''}${xp.autoTss?' (auto)':''}</div><div>Target Power: ${xp.powerTarget||''}</div><div>Notes: ${xp.notes||''}</div><div>Actual Duration: ${xp.actualDurationMin??''} min</div><div>Actual TSS: ${xp.actualTss??''}</div><div>Completed: ${xp.completed?'Yes':'No'}</div><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button id="toggleCompleteBtn">${xp.completed?'Mark Incomplete':'Mark Completed'}</button><button id="editBtn">Edit</button><button id="deleteBtn">Delete</button></div>;document.getElementById('toggleCompleteBtn').onclick=()=>{const newCompleted=!xp.completed;ev.setExtendedProp('completed',newCompleted);if(newCompleted){const ad=Number(prompt('Actual duration (min)',xp.actualDurationMin??plannedDur)??xp.actualDurationMin);const at=Number(prompt('Actual TSS',xp.actualTss??xp.tssTarget??'')??xp.actualTss);if(!Number.isNaN(ad))ev.setExtendedProp('actualDurationMin',ad);if(!Number.isNaN(at))ev.setExtendedProp('actualTss',at);}saveEvents();renderWeeklySummary();renderProjections();};document.getElementById('deleteBtn').onclick=()=>{ev.remove();saveEvents();renderWeeklySummary();renderProjections();details.textContent='Event deleted.';};document.getElementById('editBtn').onclick=()=>{const title=prompt('Title',ev.title)??ev.title;const type=prompt('Type',xp.type||'')??xp.type;const duration=Number(prompt('Planned duration (min)',xp.durationMin??plannedDur)??xp.durationMin);const power=prompt('Target power (e.g., 153–179 W)',xp.powerTarget||'')??xp.powerTarget;const tss=prompt('Planned TSS (leave blank for auto)',xp.autoTss?'':(xp.tssTarget??''));const notes=prompt('Notes',xp.notes||'')??xp.notes;const autoTss=tss==='';ev.setProp('title',title);ev.setExtendedProp('type',type);ev.setExtendedProp('durationMin',duration);ev.setExtendedProp('powerTarget',power);if(autoTss){const newTss=computeAutoTss(ev);ev.setExtendedProp('tssTarget',newTss);}else{ev.setExtendedProp('tssTarget',Number(tss));}ev.setExtendedProp('autoTss',autoTss);ev.setExtendedProp('notes',notes);saveEvents();renderWeeklySummary();renderProjections();};},eventDrop(info){saveEvents();renderWeeklySummary();renderProjections();},eventResize(info){const ev=info.event;const xp=ev.extendedProps||{};if(ev.start&&ev.end){const newDur=Math.round((new Date(ev.end)-new Date(ev.start))/60000);ev.setExtendedProp('durationMin',newDur);if(xp.autoTss){const newTss=computeAutoTss(ev);if(newTss!=null)ev.setExtendedProp('tssTarget',newTss);}}saveEvents();renderWeeklySummary();renderProjections();}});calendar.render();}
function getSavedSettings(){const raw=localStorage.getItem(LS_KEY_SETTINGS);return raw?JSON.parse(raw):null;}
function saveSettings(){localStorage.setItem(LS_KEY_SETTINGS,JSON.stringify(settings));}
function getSavedEvents(){const raw=localStorage.getItem(LS_KEY_EVENTS);return raw?JSON.parse(raw):[];}
function saveEvents(){const events=calendar.getEvents().map(ev=>({title:ev.title,start:ev.startStr||null,end:ev.endStr||null,allDay:ev.allDay||false,extendedProps:ev.extendedProps||{}}));localStorage.setItem(LS_KEY_EVENTS,JSON.stringify(events));}
function updateFtpDisplay(){const ftp=settings.ftp,w=settings.weight,prev=settings.prevFtp;document.getElementById('ftpW').textContent=${ftp} W;document.getElementById('ftpWkg').textContent=${(ftp/w).toFixed(2)} W/kg;const dw=ftp-prev,dwkg=(ftp/w)-(prev/w);document.getElementById('ftpDelta').innerHTML=Change vs last week: <span style="${dw>=0?'color:#2e8b57':'color:#c35'}">${dw>=0?'+':''}${dw} W (${dwkg>=0?'+':''}${dwkg.toFixed(2)} W/kg)</span>;document.getElementById('ftpInput').value=ftp;document.getElementById('prevFtpInput').value=prev;document.getElementById('weightInput').value=w;}
function mapActivityToEvent(src){return{title:src.name||'Imported Activity',start:src.start||(src.date||''),end:src.end||undefined,allDay:!src.start,extendedProps:{type:src.type||'Imported',durationMin:src.duration_min||null,powerTarget:src.powerTarget||'',tssTarget:src.tss??null,notes:src.notes||'',completed:true,actualDurationMin:src.duration_min||null,actualTss:src.tss??null,autoTss:false}};}
async function importIntervalsIcu(){const athleteId=document.getElementById('icuAthleteId').value;const apiKey=document.getElementById('icuApiKey').value;const start=document.getElementById('icuStart').value;const end=document.getElementById('icuEnd').value;if(!athleteId||!apiKey||!start||!end){alert('Fill athlete ID, API key, start and end dates.');return;}const url=https://intervals.icu/api/v1/athlete/${athleteId}/activities?start=${start}&end=${end};let res=await fetch(url,{headers:{Authorization:Bearer ${apiKey}}});if(!res.ok){res=await fetch(url,{headers:{apikey:apiKey}});}if(!res.ok){alert('Intervals.icu API error (auth). Please verify your API key and try again.');return;}const acts=await res.json();let imported=0;acts.forEach(a=>{const dateStr=(a.start_date_local||a.start_date||'').slice(0,10);const startISO=a.start_date_local||a.start_date;const durMin=Math.round((a.moving_time||a.elapsed_time||0)/60);const tss=a.tss??a.training_load??null;const ev=mapActivityToEvent({date:dateStr,start:startISO?startISO.replace('Z',''):dateStr,name:a.name||a.title||'ICU Activity',type:a.type||a.sport||'Ride',duration_min:durMin,tss,notes:'Imported from Intervals.icu'});calendar.addEvent(ev);imported++;});saveEvents();renderWeeklySummary();renderProjections();alert(Imported ${imported} Intervals.icu activities.);}
function renderProjections(){const events=calendar.getEvents().map(ev=>({start:ev.startStr,end:ev.endStr,extendedProps:ev.extendedProps}));const plannedMap=dailyTss(events,false),actualMap=dailyTss(events,true);const startDate=settings.projStartDate;const p=banisterProjection(plannedMap,startDate,settings.initCtl,settings.initAtl);const a=banisterProjection(actualMap,startDate,settings.initCtl,settings.initAtl);const ctx=document.getElementById('projChart').getContext('2d');if(projChart)projChart.destroy();projChart=new Chart(ctx,{type:'line',data:{labels:p.dates,datasets:[{label:'CTL (planned)',data:p.ctl,borderColor:'#59c',tension:0.2},{label:'ATL (planned)',data:p.atl,borderColor:'#e68',tension:0.2},{label:'TSB (planned)',data:p.tsb,borderColor:'#6c8',tension:0.2},{label:'CTL (actual)',data:a.ctl,borderColor:'#59c',borderDash:[5,3],tension:0.2},{label:'ATL (actual)',data:a.atl,borderColor:'#e68',borderDash:[5,3],tension:0.2},{label:'TSB (actual)',data:a.tsb,borderColor:'#6c8',borderDash:[5,3],tension:0.2}]},options:{plugins:{legend:{labels:{color:'#eee'}}},scales:{x:{ticks:{color:'#eee'},grid:{color:'#222'}},y:{ticks:{color:'#eee'},grid:{color:'#222'}}}}});const lastIdx=p.dates.length-1;const numEl=document.getElementById('projNumbers');if(lastIdx>=0){numEl.textContent=Latest (planned): CTL ${p.ctl[lastIdx].toFixed(1)}, ATL ${p.atl[lastIdx].toFixed(1)}, TSB ${(p.tsb[lastIdx]).toFixed(1)} | Latest (actual): CTL ${a.ctl[lastIdx]?.toFixed(1)??'n/a'}, ATL ${a.atl[lastIdx]?.toFixed(1)??'n/a'}, TSB ${a.tsb[lastIdx]?.toFixed(1)??'n/a'};}else{numEl.textContent='No events to project.';}}
document.addEventListener('DOMContentLoaded',()=>{const savedSettings=getSavedSettings();if(savedSettings)settings=savedSettings;updateFtpDisplay();const savedEvents=getSavedEvents();initCalendar(savedEvents||[]);renderWeeklySummary();const events=calendar.getEvents();if(events.length){const earliest=events.map(e=>e.startStr).filter(Boolean).sort()[0];settings.projStartDate=settings.projStartDate||earliest?.slice(0,10);document.getElementById('projStartDateInput').value=settings.projStartDate||'';}renderProjections();document.getElementById('updateFtpBtn').onclick=()=>{settings.ftp=Number(document.getElementById('ftpInput').value||settings.ftp);settings.prevFtp=Number(document.getElementById('prevFtpInput').value||settings.prevFtp);settings.weight=Number(document.getElementById('weightInput').value||settings.weight);saveSettings();updateFtpDisplay();calendar.getEvents().forEach(ev=>{const xp=ev.extendedProps||{};if(xp.autoTss){const newTss=computeAutoTss(ev);if(newTss!=null)ev.setExtendedProp('tssTarget',newTss);}});saveEvents();renderWeeklySummary();renderProjections();};document.getElementById('importCsvBtn').onclick=async()=>{const fileInput=document.getElementById('csvInput');if(!fileInput.files.length){alert('Select a CSV file first.');return;}const text=await fileInput.files[0].text();const events=parsePlanCsv(text);calendar.removeAllEvents();events.forEach(e=>calendar.addEvent(e));saveEvents();renderWeeklySummary();renderProjections();alert('CSV imported.');};document.getElementById('exportCsvBtn').onclick=()=>{const events=calendar.getEvents().map(ev=>({title:ev.title,start:ev.startStr,end:ev.endStr,allDay:ev.allDay,extendedProps:ev.extendedProps}));const csv=serializeCsv(events);const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='plan.csv';a.click();URL.revokeObjectURL(url);};document.getElementById('exportIcsBtn').onclick=()=>{const events=calendar.getEvents().map(ev=>({title:ev.title,start:ev.startStr,end:ev.endStr,allDay:ev.allDay,extendedProps:ev.extendedProps}));exportIcs(events);};document.getElementById('addEventBtn').onclick=()=>{const date=prompt('Date (YYYY-MM-DD)');if(!date)return;const start=prompt('Start time (HH:MM, optional)');const end=start?prompt('End time (HH:MM)'):'';const title=prompt('Title','Session')||'Session';const type=prompt('Type','Z2 Endurance')||'Z2 Endurance';const durationMin=Number(prompt('Duration (min)','60')||'60');const powerTarget=prompt('Target power (e.g., 153–179 W)','');const tssTargetStr=prompt('Planned TSS (leave blank for auto)','');const autoTss=tssTargetStr==='';const ev={title,start:start?${date}T${start}:${date},end:end?${date}T${end}:undefined,allDay:!start,extendedProps:{type,durationMin,powerTarget,tssTarget:null,notes:'',completed:false,actualDurationMin:null,actualTss:null,autoTss}};calendar.addEvent(ev);const added=calendar.getEvents().slice(-1)[0];if(autoTss){const tss=computeAutoTss(added);added.setExtendedProp('tssTarget',tss);}else{added.setExtendedProp('tssTarget',Number(tssTargetStr));}saveEvents();renderWeeklySummary();renderProjections();};document.getElementById('resetBtn').onclick=()=>{if(!confirm('Clear saved events and settings from this browser?'))return;localStorage.removeItem(LS_KEY_EVENTS);localStorage.removeItem(LS_KEY_SETTINGS);calendar.removeAllEvents();renderWeeklySummary();renderProjections();};document.getElementById('icuImportBtn').onclick=importIntervalsIcu;});
